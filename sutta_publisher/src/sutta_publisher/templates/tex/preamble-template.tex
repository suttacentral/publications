\documentclass[12pt,openany]{book}%
\usepackage{lastpage}%
\usepackage[inner=1in, outer=1in, top=.5in, bottom=1in, papersize={6in,9in}]{geometry}
\usepackage{polyglossia}
\usepackage[12pt]{moresize}
\usepackage{soul}%
\usepackage[tracking=true]{microtype}
\usepackage[]{tocbasic}
\usepackage{realscripts}
\usepackage{epigraph}%
\usepackage{setspace}%
\usepackage{sectsty}
\usepackage{fontspec}
\usepackage{marginnote}
\usepackage[bottom]{footmisc}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usepackage{extramarks}
\usepackage{graphicx}
\usepackage{verse}
\usepackage{relsize}

% use a small amount of tracking on small caps
\SetTracking[ spacing = {25*,166, } ]{ encoding = *, shape = sc }{ 25 }

% define languages
\setdefaultlanguage[]{english}
\setotherlanguage[script=Latin]{sanskrit}

%\usepackage{pagegrid}
%\pagegridsetup{top-left, step=.25in}

% define fonts
% use if arno sanskrit is unavailable
%\setmainfont{Gentium Plus}
%\newfontfamily\Semiboldsubheadfont[]{Gentium Plus}
%\newfontfamily\Semiboldnormalfont[]{Gentium Plus}
%\newfontfamily\Lightfont[]{Gentium Plus}
%\newfontfamily\Marginalfont[]{Gentium Plus}
%\newfontfamily\Allsmallcapsfont[RawFeature=+c2sc]{Gentium Plus}
%\newfontfamily\Noligaturefont[Renderer=Basic]{Gentium Plus}
%\newfontfamily\Noligaturecaptionfont[Renderer=Basic]{Gentium Plus}
%\newfontfamily\Fleuronfont[Ornament=1]{Gentium Plus}

% use if arno sanskrit is available. display is applied to \chapter and \part, subhead to \section and \subsection. When specifying semibold, the italic must be defined.
\setmainfont[Numbers=OldStyle]{Arno Pro}
\newfontfamily\Semibolddisplayfont[BoldItalicFont = Arno Pro Smbd Italic Display]{Arno Pro Smbd Display} % 
\newfontfamily\Semiboldsubheadfont[BoldItalicFont = Arno Pro Smbd Italic Subhead]{Arno Pro Smbd Subhead}
\newfontfamily\Semiboldnormalfont[BoldItalicFont = Arno Pro Smbd Italic]{Arno Pro Smbd}
\newfontfamily\Marginalfont[RawFeature=+subs]{Arno Pro Regular}
\newfontfamily\Allsmallcapsfont[RawFeature=+c2sc]{Arno Pro}
\newfontfamily\Noligaturefont[Renderer=Basic]{Arno Pro}
\newfontfamily\Noligaturecaptionfont[Renderer=Basic]{Arno Pro Caption}

% chinese fonts
\newfontfamily\cjk{Noto Serif TC}
\newcommand*{\langlzh}[1]{\cjk{#1}}%

% use subscript numerals for margin notes
\renewcommand*{\marginfont}{\Marginalfont}

% ensure margin notes have consistent vertical alignment
\renewcommand*{\marginnotevadjust}{-.17em}

% use compact lists
\setitemize{noitemsep,leftmargin=1em}
\setenumerate{noitemsep,leftmargin=1em}
\setdescription{noitemsep, style=unboxed, leftmargin=0em}

% style ToC
\DeclareTOCStyleEntries[
  raggedentrytext,
  linefill=\hfill,
  numwidth=1em,
  numsep=1ex,
  dynnumwidth,
  beforeskip=.2em plus -2pt minus -1pt
]{tocline}{chapter,section,subsection,subsubsection,paragraph,subparagraph}
\DeclareTOCStyleEntries[
  indent=0pt,
  dynindent
]{tocline}{section,subsection,subsubsection,paragraph,subparagraph}

% redefine part, so that it adds a toc entry without page number
\let\oldcontentsline\contentsline
\newcommand{\nopagecontentsline}[3]{\oldcontentsline{#1}{#2}{}}

    \makeatletter
\renewcommand*\l@part[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \addvspace{2.25em \@plus\p@}%
    \setlength\@tempdima{3em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      {\leavevmode
       \hspace*{\fill}\centering\large\scshape #1\hspace*{\fill}\llap{#2}}\par
       \smallskip
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
\makeatother

\makeatletter
\def\@pnumwidth{2em}
\makeatother

% define new sectioning command, which is only used in volumes where the pannasa is found in some parts but not others, especially in an and sn

\newcommand*{\pannasa}[1]{\clearpage\thispagestyle{empty}\begin{center}\vspace*{14em}\setstretch{.85}\huge\itshape\scshape\MakeLowercase{#1}\end{center}}

    \makeatletter
\newcommand*\l@pannasa[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \addvspace{.5em \@plus\p@}%
    \setlength\@tempdima{3em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      {\leavevmode
       \hspace*{\fill}\centering\large\itshape\scshape\MakeLowercase{#1}\hspace*{\fill}\llap{#2}}\par
       \smallskip
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
\makeatother

% global line height
\setstretch{1.05}

% allow linebreak after em-dash
\catcode`\—=13
\protected\def—{\unskip\textemdash\allowbreak}

% style headings with secsty. chapter and section are defined per-edition
\partfont{\setstretch{.85}\normalfont\centering\textsc}
\subsectionfont{\setstretch{.85}\Semiboldsubheadfont}%
\subsubsectionfont{\setstretch{.85}\Semiboldnormalfont}

% style elements of suttatitle
\newcommand*{\suttatitleacronym}[1]{\smaller[2]{#1}}
\newcommand*{\suttatitletranslation}[1]{\linebreak{#1}}
\newcommand*{\suttatitleroot}[1]{\linebreak\smaller[2]\itshape{#1}}

% redefine paragraph and subparagraph headings to not be inline
\makeatletter
% Change the style of paragraph headings %
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
            {-2.5ex\@plus -1ex \@minus -.25ex}%
            {1.25ex \@plus .25ex}%
            {\noindent\Semiboldnormalfont\normalsize}}

% Change the style of subparagraph headings %
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{\z@}%
            {-2.5ex\@plus -1ex \@minus -.25ex}%
            {1.25ex \@plus .25ex}%
            {\noindent\Semiboldnormalfont\small}}
\makeatother

% suppress page numbers on \part
\usepackage{etoolbox}
\patchcmd{\part}{\thispagestyle{plain}}{\thispagestyle{empty}}
  {}{\errmessage{Cannot patch \string\part}}

% titlepage
\newcommand*{\titlepageTranslationTitle}[1]{{\begin{center}\begin{large}{#1}\end{large}\end{center}}}
\newcommand*{\titlepageCreatorName}[1]{{\begin{center}\begin{normalsize}{#1}\end{normalsize}\end{center}}}

% halftitlepage
\newcommand*{\halftitlepageTranslationTitle}[1]{\setstretch{2.5}{\begin{Huge}\uppercase{\so{#1}}\end{Huge}}}
\newcommand*{\halftitlepageTranslationSubtitle}[1]{\setstretch{1.2}{\begin{large}{#1}\end{large}}}
\newcommand*{\halftitlepageFleuron}[1]{{\begin{large}\Fleuronfont{{#1}}\end{large}}}
\newcommand*{\halftitlepageByline}[1]{{\begin{normalsize}\textit{{#1}}\end{normalsize}}}
\newcommand*{\halftitlepageCreatorName}[1]{{\begin{LARGE}{\textsc{#1}}\end{LARGE}}}
\newcommand*{\halftitlepageVolumeNumber}[1]{{\begin{normalsize}{\Allsmallcapsfont{\textsc{#1}}}\end{normalsize}}}
\newcommand*{\halftitlepageVolumeAcronym}[1]{{\begin{normalsize}{#1}\end{normalsize}}}
\newcommand*{\halftitlepageVolumeTranslationTitle}[1]{{\begin{Large}{\textsc{#1}}\end{Large}}}
\newcommand*{\halftitlepageVolumeRootTitle}[1]{{\begin{normalsize}{\Allsmallcapsfont{\textsc{\itshape #1}}}\end{normalsize}}}
\newcommand*{\halftitlepagePublisher}[1]{{\begin{large}{\Noligaturecaptionfont\textsc{#1}}\end{large}}}

% epigraph
\renewcommand{\epigraphflush}{center}
\renewcommand*{\epigraphwidth}{.85\textwidth}
\newcommand*{\epigraphTranslatedTitle}[1]{\vspace*{.5em}\footnotesize\textsc{#1}\\}%
\newcommand*{\epigraphRootTitle}[1]{\footnotesize\textit{#1}\\}%
\newcommand*{\epigraphReference}[1]{\footnotesize{#1}}%

% custom commands for html styling classes
\newcommand*{\scnamo}[1]{\begin{center}\textit{#1}\end{center}}
\newcommand*{\scendsection}[1]{\begin{center}\textit{#1}\end{center}}
\newcommand*{\scendsutta}[1]{\begin{center}\textit{#1}\end{center}}
\newcommand*{\scendbook}[1]{\begin{center}\uppercase{#1}\end{center}}
\newcommand*{\scendkanda}[1]{\begin{center}\textbf{#1}\end{center}}
\newcommand*{\scend}[1]{\begin{center}\textit{#1}\end{center}}
\newcommand*{\scuddanaintro}[1]{\textit{#1}}
\newcommand*{\scendvagga}[1]{\begin{center}\textbf{#1}\end{center}}
\newcommand*{\scrule}[1]{\textbf{#1}}
\newcommand*{\scadd}[1]{\textit{#1}}
\newcommand*{\scevam}[1]{\textsc{#1}}
\newcommand*{\scspeaker}[1]{\hspace{2em}\textit{#1}}
\newcommand*{\scbyline}[1]{\begin{flushright}\textit{#1}\end{flushright}\bigskip}

% manage and style page header and footer. "fancy" has header and footer, "plain" has footer only
\pagestyle{fancy}
\addtolength{\headheight}{\baselineskip}
\fancyhf{}
\fancyfoot[RE,LO]{\thepage}
\fancyfoot[LE,RO]{\footnotesize\lastleftxmark}
\fancyhead[CE]{\setstretch{.85}\Noligaturefont\MakeLowercase{\textsc{\firstrightmark}}}
\fancyhead[CO]{\setstretch{.85}\Noligaturefont\MakeLowercase{\textsc{\firstleftmark}}}
\renewcommand{\headrulewidth}{0pt}
\fancypagestyle{plain}{ %
\fancyhf{} % remove everything
\fancyfoot[RE,LO]{\thepage}
\fancyfoot[LE,RO]{\footnotesize\lastleftxmark}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}}

% style footnotes
\setlength{\skip\footins}{1em}

\makeatletter
\newcommand{\@makefntextcustom}[1]{%
    \parindent 0em%
    \thefootnote.\enskip #1%
}
\renewcommand{\@makefntext}[1]{\@makefntextcustom{#1}}
\makeatother

% hang quotes (requires microtype)
\SetProtrusion
{encoding= *,}
{\textquotedblleft = {1000, },
\textquoteleft = {1000, }}

% make latex use actual font em for parindent, not Computer Modern Roman
\AtBeginDocument{\setlength{\parindent}{1em}}%
%

% Default values; a bit sloppier than normal
\tolerance 1414
\hbadness 1414
\emergencystretch 1.5em
\hfuzz 0.3pt
\clubpenalty = 10000
\widowpenalty = 10000
\displaywidowpenalty = 10000
\hfuzz \vfuzz
 \raggedbottom%
%
